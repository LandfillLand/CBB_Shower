name: Create clean branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Name of the clean branch to create'
        required: true
        default: 'clean-branch'
      source_path:
        description: 'Path inside repo to copy into the clean branch (optional)'
        required: false
        default: ''
      commit_message:
        description: 'Commit message for the new branch'
        required: true
        default: 'Initialize clean branch'
      force:
        description: 'Force push to remote if branch exists (true/false)'
        required: true
        default: 'true'

jobs:
  create_clean_branch:
    runs-on: ubuntu-latest
    env:
      BRANCH: ${{ github.event.inputs.branch }}
      SOURCE_PATH: ${{ github.event.inputs.source_path }}
      COMMIT_MSG: ${{ github.event.inputs.commit_message }}
      FORCE_PUSH: ${{ github.event.inputs.force }}
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare git author
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create orphan branch and prepare contents (robust)
        run: |
          set -eux

          # vars
          BRANCH="${BRANCH}"
          SRC="${SOURCE_PATH}"
          MSG="${COMMIT_MSG}"

          # create orphan branch (no history)
          if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
            git branch -D "$BRANCH" || true
          fi
          git checkout --orphan "$BRANCH"

          # Remove tracked files from index (but keep .git dir)
          git rm -rf --cached . || true

          # Remove all working-tree files except .git
          # (safer than rm -rf . which may remove .git)
          find . -mindepth 1 -maxdepth 1 ! -name .git -exec rm -rf {} +

          # If user provided a source_path, copy its contents into root of new branch
          if [ -n "$SRC" ]; then
            if [ -d "$SRC" ]; then
              # copy hidden files too
              shopt -s dotglob || true
              cp -a "${SRC}/." .
            else
              echo "source_path '${SRC}' not found or is not a directory; continuing with empty branch"
            fi
          fi

          # Ensure at least one file exists to commit; prefer .gitkeep
          if [ -z "$(ls -A . 2>/dev/null || true)" ]; then
            echo ".gitkeep" > .gitkeep
          fi

          # Stage everything explicitly
          git add -A

          # Try commit; if there's truly nothing to commit, fall back to an empty commit
          if ! git commit -m "$MSG" ; then
            echo "No staged changes to commit; creating an empty commit to ensure branch exists"
            git commit --allow-empty -m "$MSG"
          fi

      - name: Push clean branch to origin
        run: |
          set -eux
          if [ "${FORCE_PUSH}" = "true" ]; then
            git push origin "HEAD:${BRANCH}" --force
          else
            git push origin "HEAD:${BRANCH}"
          fi
